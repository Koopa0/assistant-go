package cli

import (
	"bufio"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"log/slog"
	"os"
	"os/signal"
	"path/filepath"
	"strings"
	"syscall"
	"time"

	"github.com/chzyer/readline"
	"github.com/fatih/color"

	"github.com/koopa0/assistant-go/internal/assistant"
	"github.com/koopa0/assistant-go/internal/cli/ui"
	"github.com/koopa0/assistant-go/internal/config"
)

// EnhancedCLI æä¾›å¢å¼·çš„å‘½ä»¤åˆ—ä»‹é¢é«”é©—
type EnhancedCLI struct {
	assistant     *assistant.Assistant
	config        *config.Config
	logger        *slog.Logger
	readline      *readline.Instance
	sessionID     string
	conversationID string
	history       []CLIMessage
	preferences   *CLIPreferences
	
	// UI çµ„ä»¶
	colorizer     *ui.Colorizer
	formatter     *ui.Formatter
	promptManager *ui.PromptManager
}

// CLIMessage è¡¨ç¤º CLI è¨Šæ¯
type CLIMessage struct {
	ID        string                 `json:"id"`
	Role      string                 `json:"role"`      // user, assistant, system
	Content   string                 `json:"content"`
	Timestamp time.Time              `json:"timestamp"`
	Metadata  map[string]interface{} `json:"metadata,omitempty"`
}

// CLIPreferences ä½¿ç”¨è€…åå¥½è¨­å®š
type CLIPreferences struct {
	Language           string            `json:"language"`            // zh-TW, en
	Theme              string            `json:"theme"`               // dark, light, auto
	ShowTimestamps     bool              `json:"show_timestamps"`
	ShowTokenUsage     bool              `json:"show_token_usage"`
	AutoSave           bool              `json:"auto_save"`
	SaveDirectory      string            `json:"save_directory"`
	MaxHistorySize     int               `json:"max_history_size"`
	CompletionEnabled  bool              `json:"completion_enabled"`
	SyntaxHighlighting bool              `json:"syntax_highlighting"`
	CustomPrompts      map[string]string `json:"custom_prompts"`
}

// NewEnhancedCLI å»ºç«‹å¢å¼·çš„ CLI å¯¦ä¾‹
func NewEnhancedCLI(assistant *assistant.Assistant, config *config.Config, logger *slog.Logger) (*EnhancedCLI, error) {
	sessionID := fmt.Sprintf("cli-%d", time.Now().Unix())
	
	// å»ºç«‹ readline å¯¦ä¾‹
	rl, err := readline.NewEx(&readline.Config{
		Prompt:          ui.GetColoredPrompt("åŠ©æ‰‹", "normal"),
		HistoryFile:     filepath.Join(os.TempDir(), "assistant-cli-history"),
		AutoComplete:    newAutoCompleter(),
		InterruptPrompt: "^C",
		EOFPrompt:       "exit",
		HistorySearchFold: true,
	})
	if err != nil {
		return nil, fmt.Errorf("å»ºç«‹ readline å¯¦ä¾‹å¤±æ•—: %w", err)
	}

	// è¼‰å…¥ä½¿ç”¨è€…åå¥½
	preferences, err := loadPreferences()
	if err != nil {
		logger.Warn("è¼‰å…¥åå¥½è¨­å®šå¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼", slog.Any("error", err))
		preferences = getDefaultPreferences()
	}

	cli := &EnhancedCLI{
		assistant:      assistant,
		config:         config,
		logger:         logger,
		readline:       rl,
		sessionID:      sessionID,
		conversationID: "",
		history:        make([]CLIMessage, 0),
		preferences:    preferences,
		colorizer:      ui.NewColorizer(preferences.Theme),
		formatter:      ui.NewFormatter(),
		promptManager:  ui.NewPromptManager(),
	}

	return cli, nil
}

// Run åŸ·è¡Œ CLI ä¸»è¿´åœˆ
func (cli *EnhancedCLI) Run(ctx context.Context) error {
	defer cli.readline.Close()

	// é¡¯ç¤ºæ­¡è¿è¨Šæ¯
	cli.showWelcomeMessage()

	// è¨­å®šä¿¡è™Ÿè™•ç†
	signalChan := make(chan os.Signal, 1)
	signal.Notify(signalChan, os.Interrupt, syscall.SIGTERM)

	// ä¸»è¿´åœˆ
	for {
		select {
		case <-ctx.Done():
			cli.showGoodbyeMessage()
			return ctx.Err()
		case <-signalChan:
			cli.showGoodbyeMessage()
			return nil
		default:
			// è®€å–ä½¿ç”¨è€…è¼¸å…¥
			input, err := cli.readline.Readline()
			if err != nil {
				if err == readline.ErrInterrupt {
					continue
				}
				if err == io.EOF {
					cli.showGoodbyeMessage()
					return nil
				}
				return fmt.Errorf("è®€å–è¼¸å…¥å¤±æ•—: %w", err)
			}

			input = strings.TrimSpace(input)
			if input == "" {
				continue
			}

			// è™•ç†å‘½ä»¤
			if strings.HasPrefix(input, "/") {
				cli.handleCommand(ctx, input)
			} else {
				cli.handleQuery(ctx, input)
			}
		}
	}
}

// handleCommand è™•ç† CLI å‘½ä»¤
func (cli *EnhancedCLI) handleCommand(ctx context.Context, command string) {
	parts := strings.Fields(command)
	if len(parts) == 0 {
		return
	}

	cmd := parts[0]
	args := parts[1:]

	switch cmd {
	case "/help", "/h":
		cli.showHelp()
	case "/clear", "/c":
		cli.clearScreen()
	case "/history", "/hist":
		cli.showHistory(args)
	case "/save":
		cli.saveConversation(args)
	case "/load":
		cli.loadConversation(args)
	case "/new", "/n":
		cli.newConversation()
	case "/preferences", "/prefs":
		cli.handlePreferences(args)
	case "/status":
		cli.showStatus(ctx)
	case "/memory":
		cli.showMemoryStatus(ctx)
	case "/tools":
		cli.showAvailableTools(ctx)
	case "/search":
		cli.handleSearch(ctx, args)
	case "/export":
		cli.exportConversation(args)
	case "/theme":
		cli.changeTheme(args)
	case "/language", "/lang":
		cli.changeLanguage(args)
	case "/prompt":
		cli.customPrompt(args)
	case "/exit", "/quit", "/q":
		os.Exit(0)
	default:
		cli.printError(fmt.Sprintf("æœªçŸ¥å‘½ä»¤: %s\nè¼¸å…¥ /help æŸ¥çœ‹å¯ç”¨å‘½ä»¤", cmd))
	}
}

// handleQuery è™•ç†ä½¿ç”¨è€…æŸ¥è©¢
func (cli *EnhancedCLI) handleQuery(ctx context.Context, query string) {
	// è¨˜éŒ„ä½¿ç”¨è€…è¨Šæ¯
	userMessage := CLIMessage{
		ID:        fmt.Sprintf("msg-%d", time.Now().UnixNano()),
		Role:      "user",
		Content:   query,
		Timestamp: time.Now(),
	}
	cli.addToHistory(userMessage)

	// é¡¯ç¤ºæ­£åœ¨è™•ç†çš„æŒ‡ç¤ºå™¨
	spinner := cli.showSpinner("æ­£åœ¨æ€è€ƒä¸­...")
	defer spinner.Stop()

	// æº–å‚™ç³»çµ±ä¸Šä¸‹æ–‡
	systemContext := map[string]interface{}{
		"session_id":      cli.sessionID,
		"conversation_id": cli.conversationID,
		"cli_mode":        true,
		"preferences":     cli.preferences,
	}

	// è™•ç†æŸ¥è©¢
	start := time.Now()
	response, err := cli.assistant.ProcessQuery(ctx, query, systemContext)
	processingTime := time.Since(start)

	spinner.Stop()

	if err != nil {
		cli.printError(fmt.Sprintf("è™•ç†æŸ¥è©¢æ™‚ç™¼ç”ŸéŒ¯èª¤: %v", err))
		return
	}

	// è¨˜éŒ„åŠ©æ‰‹å›æ‡‰
	assistantMessage := CLIMessage{
		ID:        response.ID,
		Role:      "assistant",
		Content:   response.Response,
		Timestamp: time.Now(),
		Metadata: map[string]interface{}{
			"processing_time": processingTime,
			"usage":          response.Usage,
			"context":        response.Context,
		},
	}
	cli.addToHistory(assistantMessage)

	// è¨­å®šå°è©± ID
	if cli.conversationID == "" && response.ConversationID != "" {
		cli.conversationID = response.ConversationID
	}

	// é¡¯ç¤ºå›æ‡‰
	cli.displayAssistantResponse(assistantMessage)

	// è‡ªå‹•å„²å­˜
	if cli.preferences.AutoSave {
		cli.autoSave()
	}
}

// showWelcomeMessage é¡¯ç¤ºæ­¡è¿è¨Šæ¯
func (cli *EnhancedCLI) showWelcomeMessage() {
	logo := ui.GetLogo()
	welcome := cli.getLocalizedText("welcome_message")
	
	fmt.Print(logo)
	fmt.Println(cli.colorizer.Title(welcome))
	fmt.Println(cli.colorizer.Subtitle("è¼¸å…¥ /help æŸ¥çœ‹å¯ç”¨å‘½ä»¤"))
	fmt.Println(cli.colorizer.Divider())
	fmt.Println()
}

// showGoodbyeMessage é¡¯ç¤ºå†è¦‹è¨Šæ¯
func (cli *EnhancedCLI) showGoodbyeMessage() {
	goodbye := cli.getLocalizedText("goodbye_message")
	fmt.Println()
	fmt.Println(cli.colorizer.Info(goodbye))
}

// showHelp é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
func (cli *EnhancedCLI) showHelp() {
	help := `
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                           åŠ©æ‰‹å‘½ä»¤èªªæ˜                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºæœ¬å‘½ä»¤ï¼š                                                        â”‚
â”‚   /help, /h           é¡¯ç¤ºæ­¤å¹«åŠ©è¨Šæ¯                              â”‚
â”‚   /clear, /c          æ¸…é™¤è¢å¹•                                    â”‚
â”‚   /new, /n            é–‹å§‹æ–°å°è©±                                  â”‚
â”‚   /exit, /quit, /q    çµæŸç¨‹å¼                                    â”‚
â”‚                                                                  â”‚
â”‚ å°è©±ç®¡ç†ï¼š                                                        â”‚
â”‚   /history [æ•¸é‡]     é¡¯ç¤ºå°è©±æ­·å²                                â”‚
â”‚   /save [æª”å]        å„²å­˜ç•¶å‰å°è©±                                â”‚
â”‚   /load [æª”å]        è¼‰å…¥å°è©±                                    â”‚
â”‚   /export [æ ¼å¼]      åŒ¯å‡ºå°è©± (json, markdown, txt)             â”‚
â”‚                                                                  â”‚
â”‚ ç³»çµ±åŠŸèƒ½ï¼š                                                        â”‚
â”‚   /status             é¡¯ç¤ºç³»çµ±ç‹€æ…‹                                â”‚
â”‚   /memory             é¡¯ç¤ºè¨˜æ†¶é«”ç‹€æ…‹                              â”‚
â”‚   /tools              é¡¯ç¤ºå¯ç”¨å·¥å…·                                â”‚
â”‚   /search [é—œéµå­—]    æœå°‹çŸ¥è­˜åº«                                  â”‚
â”‚                                                                  â”‚
â”‚ å€‹äººåŒ–è¨­å®šï¼š                                                      â”‚
â”‚   /preferences        ç®¡ç†åå¥½è¨­å®š                                â”‚
â”‚   /theme [ä¸»é¡Œ]       æ›´æ”¹ä¸»é¡Œ (dark, light, auto)               â”‚
â”‚   /language [èªè¨€]    æ›´æ”¹èªè¨€ (zh-TW, en)                       â”‚
â”‚   /prompt [åç¨±]      ä½¿ç”¨è‡ªè¨‚æç¤º                                â”‚
â”‚                                                                  â”‚
â”‚ æç¤ºï¼šç›´æ¥è¼¸å…¥å•é¡Œå³å¯é–‹å§‹å°è©±ï¼                                   â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
`
	fmt.Print(cli.colorizer.Help(help))
}

// showStatus é¡¯ç¤ºç³»çµ±ç‹€æ…‹
func (cli *EnhancedCLI) showStatus(ctx context.Context) {
	fmt.Println(cli.colorizer.Title("ğŸ”§ ç³»çµ±ç‹€æ…‹"))
	fmt.Println(cli.colorizer.Divider())
	
	// åŸºæœ¬è³‡è¨Š
	fmt.Printf("æœƒè©± ID: %s\n", cli.colorizer.Value(cli.sessionID))
	fmt.Printf("å°è©± ID: %s\n", cli.colorizer.Value(cli.conversationID))
	fmt.Printf("è¨Šæ¯æ•¸é‡: %s\n", cli.colorizer.Value(fmt.Sprintf("%d", len(cli.history))))
	
	// åå¥½è¨­å®š
	fmt.Printf("èªè¨€: %s\n", cli.colorizer.Value(cli.preferences.Language))
	fmt.Printf("ä¸»é¡Œ: %s\n", cli.colorizer.Value(cli.preferences.Theme))
	fmt.Printf("è‡ªå‹•å„²å­˜: %s\n", cli.colorizer.Value(fmt.Sprintf("%t", cli.preferences.AutoSave)))
	
	// è¨˜æ†¶é«”è³‡è¨Š
	fmt.Println(cli.colorizer.Divider())
	fmt.Println(cli.colorizer.Subtitle("è¨˜æ†¶é«”ç‹€æ…‹"))
	
	// TODO: å¾åŠ©æ‰‹ç²å–çœŸå¯¦çš„è¨˜æ†¶é«”ç‹€æ…‹
	fmt.Printf("å·¥ä½œè¨˜æ†¶é«”: %s\n", cli.colorizer.Success("æ­£å¸¸"))
	fmt.Printf("èªç¾©è¨˜æ†¶é«”: %s\n", cli.colorizer.Success("æ­£å¸¸"))
	fmt.Printf("ç¨‹åºè¨˜æ†¶é«”: %s\n", cli.colorizer.Success("æ­£å¸¸"))
	
	fmt.Println()
}

// showMemoryStatus é¡¯ç¤ºè©³ç´°è¨˜æ†¶é«”ç‹€æ…‹
func (cli *EnhancedCLI) showMemoryStatus(ctx context.Context) {
	fmt.Println(cli.colorizer.Title("ğŸ§  è¨˜æ†¶é«”è©³ç´°ç‹€æ…‹"))
	fmt.Println(cli.colorizer.Divider())
	
	// TODO: å¾åŠ©æ‰‹çš„è¨˜æ†¶é«”ç³»çµ±ç²å–çœŸå¯¦ç‹€æ…‹
	fmt.Println(cli.colorizer.Subtitle("å·¥ä½œè¨˜æ†¶é«”"))
	fmt.Printf("  å®¹é‡ä½¿ç”¨ç‡: %s\n", cli.colorizer.Value("45%"))
	fmt.Printf("  æ´»èºé …ç›®: %s\n", cli.colorizer.Value("12"))
	fmt.Printf("  æ³¨æ„ç„¦é»: %s\n", cli.colorizer.Value("API è¨­è¨ˆ"))
	
	fmt.Println(cli.colorizer.Subtitle("èªç¾©è¨˜æ†¶é«”"))
	fmt.Printf("  æ¦‚å¿µæ•¸é‡: %s\n", cli.colorizer.Value("1,234"))
	fmt.Printf("  é—œä¿‚æ•¸é‡: %s\n", cli.colorizer.Value("3,456"))
	fmt.Printf("  æœ€æ–°å­¸ç¿’: %s\n", cli.colorizer.Value("CLI è¨­è¨ˆæ¨¡å¼"))
	
	fmt.Println(cli.colorizer.Subtitle("ç¨‹åºè¨˜æ†¶é«”"))
	fmt.Printf("  ç¨‹åºæ•¸é‡: %s\n", cli.colorizer.Value("89"))
	fmt.Printf("  æŠ€èƒ½æ•¸é‡: %s\n", cli.colorizer.Value("45"))
	fmt.Printf("  æˆåŠŸç‡: %s\n", cli.colorizer.Value("92%"))
	
	fmt.Println()
}

// showAvailableTools é¡¯ç¤ºå¯ç”¨å·¥å…·
func (cli *EnhancedCLI) showAvailableTools(ctx context.Context) {
	fmt.Println(cli.colorizer.Title("ğŸ› ï¸  å¯ç”¨å·¥å…·"))
	fmt.Println(cli.colorizer.Divider())
	
	// TODO: å¾å·¥å…·è¨»å†Šè¡¨ç²å–çœŸå¯¦å·¥å…·åˆ—è¡¨
	tools := []struct {
		Name        string
		Description string
		Category    string
		Status      string
	}{
		{"code_analyzer", "åˆ†æç¨‹å¼ç¢¼çµæ§‹å’Œå“è³ª", "é–‹ç™¼å·¥å…·", "å¯ç”¨"},
		{"file_processor", "è™•ç†å’Œåˆ†ææª”æ¡ˆå…§å®¹", "æª”æ¡ˆå·¥å…·", "å¯ç”¨"},
		{"web_searcher", "æœå°‹ç¶²è·¯è³‡è¨Š", "è³‡è¨Šå·¥å…·", "å¯ç”¨"},
		{"database_tool", "è³‡æ–™åº«æŸ¥è©¢å’Œç®¡ç†", "è³‡æ–™å·¥å…·", "å¯ç”¨"},
	}
	
	for _, tool := range tools {
		status := cli.colorizer.Success("â—")
		if tool.Status != "å¯ç”¨" {
			status = cli.colorizer.Error("â—")
		}
		
		fmt.Printf("%s %s - %s (%s)\n", 
			status,
			cli.colorizer.Bold(tool.Name),
			tool.Description,
			cli.colorizer.Dim(tool.Category),
		)
	}
	
	fmt.Println()
}

// displayAssistantResponse é¡¯ç¤ºåŠ©æ‰‹å›æ‡‰
func (cli *EnhancedCLI) displayAssistantResponse(message CLIMessage) {
	fmt.Println()
	
	// é¡¯ç¤ºæ™‚é–“æˆ³ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
	if cli.preferences.ShowTimestamps {
		timestamp := message.Timestamp.Format("15:04:05")
		fmt.Printf("%s ", cli.colorizer.Dim(timestamp))
	}
	
	// é¡¯ç¤ºè§’è‰²æ¨™è­˜
	fmt.Printf("%s ", cli.colorizer.Assistant("ğŸ¤– åŠ©æ‰‹"))
	
	// é¡¯ç¤ºå›æ‡‰å…§å®¹
	content := cli.formatter.FormatContent(message.Content, cli.preferences.SyntaxHighlighting)
	fmt.Println(content)
	
	// é¡¯ç¤ºå…ƒæ•¸æ“šï¼ˆå¦‚æœæœ‰ï¼‰
	if metadata := message.Metadata; metadata != nil {
		if cli.preferences.ShowTokenUsage {
			if usage, ok := metadata["usage"]; ok {
				cli.displayTokenUsage(usage)
			}
		}
		
		if processingTime, ok := metadata["processing_time"]; ok {
			if duration, ok := processingTime.(time.Duration); ok {
				fmt.Printf("%s è™•ç†æ™‚é–“: %v\n", 
					cli.colorizer.Dim("â±ï¸"),
					cli.colorizer.Dim(duration.String()),
				)
			}
		}
	}
	
	fmt.Println()
}

// displayTokenUsage é¡¯ç¤º token ä½¿ç”¨æƒ…æ³
func (cli *EnhancedCLI) displayTokenUsage(usage interface{}) {
	if usageMap, ok := usage.(map[string]interface{}); ok {
		fmt.Printf("%s Token ä½¿ç”¨: ", cli.colorizer.Dim("ğŸ“Š"))
		
		if input, ok := usageMap["input_tokens"]; ok {
			fmt.Printf("è¼¸å…¥ %v, ", cli.colorizer.Dim(fmt.Sprintf("%v", input)))
		}
		if output, ok := usageMap["output_tokens"]; ok {
			fmt.Printf("è¼¸å‡º %v, ", cli.colorizer.Dim(fmt.Sprintf("%v", output)))
		}
		if total, ok := usageMap["total_tokens"]; ok {
			fmt.Printf("ç¸½è¨ˆ %v", cli.colorizer.Dim(fmt.Sprintf("%v", total)))
		}
		
		fmt.Println()
	}
}

// è¼”åŠ©æ–¹æ³•

// addToHistory æ·»åŠ è¨Šæ¯åˆ°æ­·å²è¨˜éŒ„
func (cli *EnhancedCLI) addToHistory(message CLIMessage) {
	cli.history = append(cli.history, message)
	
	// é™åˆ¶æ­·å²è¨˜éŒ„å¤§å°
	if len(cli.history) > cli.preferences.MaxHistorySize {
		cli.history = cli.history[1:]
	}
}

// showSpinner é¡¯ç¤ºè™•ç†æŒ‡ç¤ºå™¨
func (cli *EnhancedCLI) showSpinner(message string) *ui.Spinner {
	spinner := ui.NewSpinner(message)
	spinner.Start()
	return spinner
}

// printError é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
func (cli *EnhancedCLI) printError(message string) {
	fmt.Printf("%s %s\n", cli.colorizer.Error("âŒ"), cli.colorizer.Error(message))
}

// printSuccess é¡¯ç¤ºæˆåŠŸè¨Šæ¯
func (cli *EnhancedCLI) printSuccess(message string) {
	fmt.Printf("%s %s\n", cli.colorizer.Success("âœ…"), cli.colorizer.Success(message))
}

// clearScreen æ¸…é™¤è¢å¹•
func (cli *EnhancedCLI) clearScreen() {
	fmt.Print("\033[2J\033[H")
}

// getLocalizedText ç²å–æœ¬åœ°åŒ–æ–‡å­—
func (cli *EnhancedCLI) getLocalizedText(key string) string {
	texts := map[string]map[string]string{
		"zh-TW": {
			"welcome_message": "æ­¡è¿ä½¿ç”¨æ™ºæ…§åŠ©æ‰‹ï¼æˆ‘æ˜¯æ‚¨çš„å€‹äºº AI å¤¥ä¼´ï¼Œéš¨æ™‚ç‚ºæ‚¨æä¾›å”åŠ©ã€‚",
			"goodbye_message": "æ„Ÿè¬ä½¿ç”¨æ™ºæ…§åŠ©æ‰‹ï¼æœŸå¾…ä¸‹æ¬¡ç‚ºæ‚¨æœå‹™ã€‚",
		},
		"en": {
			"welcome_message": "Welcome to the Intelligent Assistant! I'm your personal AI companion, ready to help you anytime.",
			"goodbye_message": "Thank you for using the Intelligent Assistant! Looking forward to serving you again.",
		},
	}
	
	if langTexts, ok := texts[cli.preferences.Language]; ok {
		if text, ok := langTexts[key]; ok {
			return text
		}
	}
	
	// é è¨­è¿”å›ç¹é«”ä¸­æ–‡
	if zhTexts, ok := texts["zh-TW"]; ok {
		if text, ok := zhTexts[key]; ok {
			return text
		}
	}
	
	return key
}

// æ›´å¤šå¯¦ä½œæ–¹æ³•...

// newConversation é–‹å§‹æ–°å°è©±
func (cli *EnhancedCLI) newConversation() {
	cli.conversationID = ""
	cli.history = make([]CLIMessage, 0)
	cli.printSuccess("å·²é–‹å§‹æ–°å°è©±")
}

// autoSave è‡ªå‹•å„²å­˜å°è©±
func (cli *EnhancedCLI) autoSave() {
	if len(cli.history) == 0 {
		return
	}
	
	filename := fmt.Sprintf("conversation-%s.json", time.Now().Format("20060102-150405"))
	filepath := filepath.Join(cli.preferences.SaveDirectory, filename)
	
	if err := cli.saveToFile(filepath); err != nil {
		cli.logger.Error("è‡ªå‹•å„²å­˜å¤±æ•—", slog.Any("error", err))
	}
}

// saveToFile å„²å­˜å°è©±åˆ°æª”æ¡ˆ
func (cli *EnhancedCLI) saveToFile(filepath string) error {
	data := map[string]interface{}{
		"session_id":      cli.sessionID,
		"conversation_id": cli.conversationID,
		"created_at":      time.Now(),
		"messages":        cli.history,
		"preferences":     cli.preferences,
	}
	
	file, err := os.Create(filepath)
	if err != nil {
		return fmt.Errorf("å»ºç«‹æª”æ¡ˆå¤±æ•—: %w", err)
	}
	defer file.Close()
	
	encoder := json.NewEncoder(file)
	encoder.SetIndent("", "  ")
	
	return encoder.Encode(data)
}

// loadPreferences è¼‰å…¥ä½¿ç”¨è€…åå¥½
func loadPreferences() (*CLIPreferences, error) {
	configDir, err := os.UserConfigDir()
	if err != nil {
		return nil, err
	}
	
	prefsPath := filepath.Join(configDir, "assistant", "cli-preferences.json")
	
	file, err := os.Open(prefsPath)
	if err != nil {
		return nil, err
	}
	defer file.Close()
	
	var prefs CLIPreferences
	if err := json.NewDecoder(file).Decode(&prefs); err != nil {
		return nil, err
	}
	
	return &prefs, nil
}

// getDefaultPreferences ç²å–é è¨­åå¥½è¨­å®š
func getDefaultPreferences() *CLIPreferences {
	homeDir, _ := os.UserHomeDir()
	saveDir := filepath.Join(homeDir, "Documents", "Assistant")
	
	return &CLIPreferences{
		Language:           "zh-TW",
		Theme:              "auto",
		ShowTimestamps:     true,
		ShowTokenUsage:     true,
		AutoSave:           true,
		SaveDirectory:      saveDir,
		MaxHistorySize:     1000,
		CompletionEnabled:  true,
		SyntaxHighlighting: true,
		CustomPrompts:      make(map[string]string),
	}
}

// newAutoCompleter å»ºç«‹è‡ªå‹•å®Œæˆå™¨
func newAutoCompleter() *readline.PrefixCompleter {
	return readline.NewPrefixCompleter(
		readline.PcItem("/help"),
		readline.PcItem("/clear"),
		readline.PcItem("/history"),
		readline.PcItem("/save"),
		readline.PcItem("/load"),
		readline.PcItem("/new"),
		readline.PcItem("/preferences"),
		readline.PcItem("/status"),
		readline.PcItem("/memory"),
		readline.PcItem("/tools"),
		readline.PcItem("/search"),
		readline.PcItem("/export"),
		readline.PcItem("/theme",
			readline.PcItem("dark"),
			readline.PcItem("light"),
			readline.PcItem("auto"),
		),
		readline.PcItem("/language",
			readline.PcItem("zh-TW"),
			readline.PcItem("en"),
		),
		readline.PcItem("/exit"),
		readline.PcItem("/quit"),
	)
}